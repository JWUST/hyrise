// Copyright (c) 2012 Hasso-Plattner-Institut fuer Softwaresystemtechnik GmbH. All rights reserved.
#ifndef SRC_LIB_ACCESS_RADIXJOIN_H_
#define SRC_LIB_ACCESS_RADIXJOIN_H_

#include "access/system/ParallelizablePlanOperation.h"

namespace hyrise {
namespace access {

class RadixJoin : public ParallelizablePlanOperation {
public:
  void executePlanOperation();
  static std::shared_ptr<PlanOperation> parse(Json::Value &data);
  const std::string vname();
  void setBits1(const uint32_t b);
  void setBits2(const uint32_t b);
  uint32_t bits1() const;
  uint32_t bits2() const;

  virtual std::vector<std::shared_ptr<Task> > applyDynamicParallelization(size_t maxTaskRunTime);
protected:
  uint determineDynamicCount(size_t maxTaskRunTime);

private:
  uint32_t _bits1;
  uint32_t _bits2;

  int table_size[7] = {144600000, 72300000, 14460000, 7230000, 1446000, 723000, 144600};

int lookup[7][121][2] = {{{24116, 1}, {14841, 2}, {10817, 3}, {8563, 4}, {7104, 5}, {6082, 6}, {5322, 7}, {4735, 8}, {4272, 9}, {3937, 10}, {3574, 11}, {3334, 12}, {3102, 13}, {2896, 14}, {2735, 15}, {2454, 17}, {2583, 16}, {2360, 18}, {2236, 19}, {2148, 20}, {2077, 22}, {2060, 23}, {2020, 24}, {2116, 21}, {1979, 25}, {1952, 26}, {1922, 27}, {1842, 30}, {1898, 28}, {1868, 29}, {1795, 32}, {1817, 31}, {1737, 34}, {1764, 33}, {1710, 35}, {1688, 36}, {1611, 39}, {1661, 37}, {1633, 38}, {1592, 40}, {1549, 42}, {1567, 41}, {1509, 44}, {1459, 47}, {1529, 43}, {1404, 50}, {1476, 46}, {1418, 49}, {1490, 45}, {1443, 48}, {1386, 51}, {1354, 53}, {1368, 52}, {1335, 54}, {1322, 55}, {1309, 56}, {1279, 58}, {1291, 57}, {1266, 59}, {1249, 60}, {1225, 62}, {1240, 61}, {1211, 63}, {1199, 64}, {1188, 65}, {1101, 73}, {1026, 81}, {960, 89}, {901, 97}, {853, 105}, {804, 113}, {763, 121}, {728, 129}, {694, 137}, {662, 145}, {635, 153}, {609, 161}, {585, 169}, {564, 177}, {543, 185}, {524, 193}, {507, 201}, {491, 209}, {476, 217}, {461, 225}, {447, 233}, {435, 241}, {423, 249}, {413, 256}, {392, 272}, {373, 288}, {357, 304}, {341, 320}, {327, 336}, {316, 352}, {304, 368}, {294, 384}, {284, 400}, {275, 416}, {267, 432}, {259, 448}, {252, 464}, {246, 480}, {240, 496}, {234, 512}, {225, 544}, {217, 576}, {209, 608}, {203, 640}, {198, 672}, {193, 704}, {190, 736}, {187, 768}, {184, 800}, {183, 832}, {181, 864}, {180, 896}, {179, 928}, {180, 960}, {180, 992}, {180, 1024}},
{{6566, 1}, {4144, 2}, {2999, 3}, {2404, 4}, {2017, 5}, {1746, 6}, {1383, 8}, {1541, 7}, {1149, 10}, {1256, 9}, {1064, 11}, {980, 12}, {911, 13}, {853, 14}, {802, 15}, {760, 16}, {715, 17}, {678, 18}, {644, 19}, {603, 21}, {613, 20}, {592, 22}, {581, 23}, {570, 24}, {561, 25}, {543, 27}, {551, 26}, {534, 28}, {526, 29}, {517, 30}, {493, 33}, {501, 32}, {509, 31}, {479, 35}, {486, 34}, {472, 36}, {465, 37}, {458, 38}, {452, 39}, {445, 40}, {439, 41}, {434, 42}, {428, 43}, {422, 44}, {409, 47}, {417, 45}, {396, 49}, {411, 46}, {401, 48}, {391, 50}, {382, 52}, {387, 51}, {378, 53}, {361, 57}, {373, 54}, {369, 55}, {365, 56}, {357, 58}, {353, 59}, {350, 60}, {335, 64}, {346, 61}, {342, 62}, {338, 63}, {331, 65}, {306, 73}, {285, 81}, {266, 89}, {250, 97}, {235, 105}, {223, 113}, {211, 121}, {201, 129}, {192, 137}, {183, 145}, {175, 153}, {168, 161}, {162, 169}, {156, 177}, {150, 185}, {145, 193}, {141, 201}, {136, 209}, {132, 217}, {129, 225}, {125, 233}, {122, 241}, {119, 249}, {116, 256}, {111, 272}, {106, 288}, {102, 304}, {98, 320}, {95, 336}, {92, 352}, {90, 368}, {87, 384}, {85, 400}, {84, 416}, {82, 432}, {81, 448}, {79, 464}, {78, 480}, {77, 496}, {77, 512}, {76, 544}, {75, 576}, {75, 608}, {75, 640}, {76, 672}, {77, 704}, {78, 736}, {79, 768}, {80, 800}, {83, 832}, {85, 864}, {88, 896}, {90, 928}, {93, 960}, {96, 992}, {99, 1024}},
{{743, 1}, {468, 2}, {345, 3}, {274, 4}, {230, 5}, {193, 6}, {169, 7}, {134, 9}, {149, 8}, {122, 10}, {113, 11}, {105, 12}, {97, 13}, {91, 14}, {85, 15}, {76, 17}, {81, 16}, {73, 18}, {69, 19}, {66, 20}, {65, 21}, {64, 22}, {62, 23}, {62, 24}, {61, 25}, {58, 28}, {60, 26}, {59, 27}, {57, 29}, {56, 30}, {55, 31}, {54, 33}, {53, 34}, {52, 36}, {55, 32}, {53, 35}, {51, 37}, {50, 38}, {50, 39}, {49, 41}, {48, 42}, {49, 40}, {47, 43}, {46, 46}, {47, 44}, {46, 45}, {44, 50}, {45, 48}, {45, 47}, {43, 51}, {44, 49}, {43, 52}, {41, 56}, {42, 54}, {41, 57}, {43, 53}, {42, 55}, {40, 58}, {40, 61}, {41, 60}, {40, 59}, {39, 62}, {38, 64}, {39, 63}, {38, 65}, {35, 73}, {34, 81}, {32, 89}, {30, 97}, {29, 105}, {27, 113}, {26, 121}, {26, 129}, {25, 137}, {24, 145}, {22, 153}, {21, 161}, {23, 169}, {20, 177}, {19, 185}, {19, 193}, {21, 201}, {21, 209}, {20, 217}, {20, 225}, {20, 233}, {20, 241}, {19, 249}, {19, 256}, {19, 272}, {19, 288}, {19, 304}, {20, 320}, {20, 336}, {20, 352}, {21, 368}, {21, 384}, {22, 400}, {22, 416}, {23, 432}, {24, 448}, {24, 464}, {25, 480}, {26, 496}, {27, 512}, {29, 544}, {31, 576}, {33, 608}, {35, 640}, {38, 672}, {41, 704}, {44, 736}, {47, 768}, {50, 800}, {53, 832}, {56, 864}, {60, 896}, {64, 928}, {67, 960}, {71, 992}, {76, 1024}},
{{366, 1}, {225, 2}, {167, 3}, {133, 4}, {111, 5}, {95, 6}, {83, 7}, {73, 8}, {66, 9}, {60, 10}, {55, 11}, {51, 12}, {48, 13}, {45, 14}, {42, 15}, {39, 16}, {37, 17}, {35, 18}, {34, 19}, {31, 21}, {32, 20}, {31, 22}, {31, 23}, {30, 24}, {29, 26}, {29, 25}, {29, 27}, {27, 30}, {29, 28}, {27, 31}, {28, 29}, {26, 32}, {26, 33}, {26, 34}, {25, 35}, {25, 36}, {25, 37}, {25, 38}, {24, 39}, {24, 41}, {24, 40}, {23, 43}, {24, 42}, {22, 46}, {23, 45}, {23, 44}, {23, 47}, {22, 49}, {22, 51}, {22, 48}, {22, 50}, {22, 52}, {21, 54}, {21, 53}, {21, 55}, {21, 57}, {21, 56}, {20, 58}, {20, 59}, {20, 61}, {20, 62}, {20, 60}, {20, 64}, {20, 63}, {19, 65}, {18, 73}, {18, 81}, {17, 89}, {16, 97}, {16, 105}, {15, 113}, {15, 121}, {14, 129}, {14, 137}, {14, 145}, {14, 153}, {14, 161}, {13, 169}, {13, 177}, {13, 185}, {13, 193}, {13, 201}, {13, 209}, {13, 217}, {13, 225}, {13, 233}, {13, 241}, {13, 249}, {13, 256}, {14, 272}, {14, 288}, {14, 304}, {14, 320}, {15, 336}, {15, 352}, {16, 368}, {17, 384}, {17, 400}, {18, 416}, {19, 432}, {20, 448}, {21, 464}, {21, 480}, {22, 496}, {24, 512}, {26, 544}, {29, 576}, {31, 608}, {34, 640}, {36, 672}, {39, 704}, {42, 736}, {45, 768}, {48, 800}, {51, 832}, {55, 864}, {58, 896}, {63, 928}, {67, 960}, {71, 992}, {74, 1024}},
{{71, 1}, {44, 2}, {33, 3}, {27, 4}, {22, 5}, {19, 6}, {17, 7}, {14, 9}, {15, 8}, {13, 10}, {12, 11}, {11, 12}, {10, 13}, {9, 14}, {9, 15}, {9, 16}, {9, 17}, {8, 18}, {8, 19}, {8, 20}, {8, 21}, {7, 23}, {7, 22}, {7, 25}, {7, 24}, {7, 26}, {7, 27}, {7, 28}, {7, 29}, {7, 30}, {6, 32}, {6, 31}, {6, 33}, {6, 35}, {6, 34}, {6, 38}, {6, 37}, {6, 36}, {6, 40}, {6, 39}, {6, 42}, {6, 43}, {6, 41}, {5, 45}, {5, 46}, {6, 44}, {5, 47}, {5, 48}, {5, 49}, {5, 54}, {5, 50}, {5, 51}, {5, 53}, {5, 52}, {5, 56}, {5, 55}, {5, 58}, {5, 57}, {5, 59}, {5, 62}, {5, 60}, {5, 64}, {5, 61}, {5, 63}, {5, 65}, {4, 73}, {4, 81}, {4, 89}, {4, 97}, {4, 105}, {4, 113}, {4, 121}, {4, 129}, {4, 137}, {4, 145}, {4, 153}, {4, 161}, {4, 169}, {5, 177}, {5, 185}, {5, 193}, {5, 201}, {5, 209}, {6, 217}, {6, 225}, {6, 241}, {6, 233}, {7, 249}, {7, 256}, {8, 272}, {8, 288}, {9, 304}, {9, 320}, {10, 336}, {10, 352}, {11, 368}, {12, 384}, {13, 400}, {13, 416}, {14, 432}, {15, 448}, {16, 464}, {17, 480}, {18, 496}, {19, 512}, {21, 544}, {24, 576}, {26, 608}, {29, 640}, {32, 672}, {35, 704}, {38, 736}, {41, 768}, {44, 800}, {48, 832}, {51, 864}, {55, 896}, {59, 928}, {67, 992}, {63, 960}, {71, 1024}},
{{35, 1}, {22, 2}, {17, 3}, {14, 4}, {11, 5}, {10, 6}, {9, 7}, {8, 8}, {7, 10}, {7, 9}, {6, 11}, {6, 12}, {6, 13}, {5, 14}, {5, 15}, {5, 16}, {5, 17}, {5, 18}, {5, 19}, {5, 20}, {4, 21}, {4, 22}, {4, 23}, {4, 26}, {4, 25}, {4, 24}, {4, 27}, {4, 28}, {4, 31}, {4, 29}, {4, 30}, {4, 33}, {4, 32}, {4, 38}, {4, 35}, {4, 36}, {4, 34}, {4, 37}, {3, 40}, {4, 39}, {3, 41}, {3, 43}, {3, 42}, {3, 44}, {3, 45}, {3, 48}, {3, 47}, {3, 49}, {3, 46}, {3, 51}, {3, 55}, {3, 50}, {3, 54}, {3, 52}, {3, 56}, {3, 53}, {3, 57}, {3, 59}, {3, 60}, {3, 58}, {3, 62}, {3, 61}, {3, 63}, {3, 65}, {3, 64}, {3, 73}, {3, 81}, {3, 89}, {3, 97}, {3, 105}, {3, 121}, {3, 113}, {3, 129}, {3, 137}, {3, 145}, {3, 153}, {4, 169}, {3, 161}, {4, 177}, {4, 185}, {4, 193}, {4, 201}, {4, 209}, {5, 217}, {5, 225}, {5, 233}, {5, 241}, {5, 249}, {6, 256}, {6, 272}, {7, 288}, {7, 304}, {8, 320}, {9, 336}, {9, 352}, {10, 368}, {11, 384}, {12, 400}, {13, 416}, {14, 432}, {15, 448}, {15, 464}, {16, 480}, {18, 496}, {19, 512}, {21, 544}, {24, 576}, {26, 608}, {29, 640}, {32, 672}, {34, 704}, {37, 736}, {41, 768}, {44, 800}, {48, 832}, {51, 864}, {54, 896}, {58, 928}, {62, 960}, {66, 992}, {70, 1024}},
{{5, 1}, {3, 2}, {2, 3}, {2, 4}, {2, 5}, {2, 6}, {2, 7}, {2, 8}, {2, 9}, {1, 10}, {1, 11}, {2, 12}, {2, 13}, {2, 14}, {2, 15}, {2, 16}, {2, 17}, {2, 18}, {2, 19}, {2, 20}, {2, 21}, {2, 22}, {2, 26}, {2, 24}, {2, 25}, {2, 23}, {2, 27}, {2, 28}, {2, 32}, {2, 30}, {2, 29}, {2, 33}, {2, 31}, {2, 34}, {2, 35}, {2, 36}, {2, 37}, {2, 38}, {2, 41}, {2, 42}, {2, 39}, {2, 40}, {2, 43}, {2, 44}, {2, 46}, {2, 45}, {2, 48}, {2, 49}, {2, 47}, {2, 51}, {2, 50}, {2, 52}, {2, 53}, {2, 54}, {2, 55}, {2, 56}, {2, 57}, {2, 58}, {2, 59}, {2, 62}, {2, 63}, {1, 60}, {2, 61}, {2, 64}, {2, 65}, {2, 73}, {2, 81}, {2, 89}, {2, 97}, {2, 105}, {2, 113}, {2, 129}, {2, 121}, {2, 137}, {3, 153}, {3, 161}, {2, 145}, {3, 169}, {3, 177}, {3, 185}, {3, 193}, {4, 209}, {4, 201}, {4, 217}, {4, 233}, {4, 225}, {5, 249}, {5, 241}, {5, 256}, {6, 272}, {7, 304}, {6, 288}, {8, 320}, {8, 336}, {9, 352}, {10, 368}, {11, 384}, {11, 400}, {13, 432}, {12, 416}, {14, 448}, {16, 480}, {15, 464}, {18, 512}, {21, 544}, {17, 496}, {23, 576}, {26, 608}, {28, 640}, {32, 672}, {34, 704}, {37, 736}, {41, 768}, {44, 800}, {48, 832}, {55, 896}, {52, 864}, {59, 928}, {63, 960}, {67, 992}, {70, 1024}}};

void distributePartitions(
          const int partitions,
          const int join_count,
          const int current_join,
          int &first,
          int &last) const;

void copyTaskAttributesFromThis(std::shared_ptr<PlanOperation> to);

std::vector<std::shared_ptr<Task> > build_probe_side(std::string prefix,
                                                          field_t &fields,
                                                          uint probe_par,
                                                          uint32_t bits1,
                                                          uint32_t bits2,
                                                          std::shared_ptr<Task> input);

std::vector<std::shared_ptr<Task> > build_hash_side(std::string prefix,
                                                          field_t &fields,
                                                          uint probe_par,
                                                          uint32_t bits1,
                                                          uint32_t bits2,
                                                          std::shared_ptr<Task> input);

};

}
}


#endif  // SRC_LIB_ACCESS_RADIXJOIN_H_

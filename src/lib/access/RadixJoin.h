// Copyright (c) 2012 Hasso-Plattner-Institut fuer Softwaresystemtechnik GmbH. All rights reserved.
#ifndef SRC_LIB_ACCESS_RADIXJOIN_H_
#define SRC_LIB_ACCESS_RADIXJOIN_H_

#include "access/system/ParallelizablePlanOperation.h"

namespace hyrise {
namespace access {

class RadixJoin : public ParallelizablePlanOperation {
public:
  void executePlanOperation();
  static std::shared_ptr<PlanOperation> parse(Json::Value &data);
  const std::string vname();
  void setBits1(const uint32_t b);
  void setBits2(const uint32_t b);
  uint32_t bits1() const;
  uint32_t bits2() const;

  virtual std::vector<std::shared_ptr<Task> > applyDynamicParallelization(size_t maxTaskRunTime);
protected:
  uint determineDynamicCount(size_t maxTaskRunTime);

private:
  uint32_t _bits1;
  uint32_t _bits2;

  int table_size[7] = {144600000, 72300000, 14460000, 7230000, 1446000, 723000, 144600};

int lookup[7][121][2] = {{{3710, 241}, {4258, 209}, {3819, 233}, {3819, 225}, {3820, 217}, {2894, 352}, {2549, 368}, {3684, 249}, {3356, 256}, {2550, 384}, {2549, 400}, {3350, 288}, {3350, 272}, {3043, 320}, {3348, 304}, {4876, 193}, {2549, 416}, {3042, 336}, {4382, 201}, {4878, 177}, {5241, 161}, {4877, 185}, {5186, 169}, {2550, 448}, {5241, 153}, {2561, 432}, {6170, 129}, {6171, 137}, {2549, 464}, {5687, 145}, {6930, 113}, {6804, 105}, {6765, 121}, {2426, 480}, {2425, 496}, {8371, 89}, {2229, 512}, {2227, 544}, {7858, 97}, {9573, 73}, {2215, 576}, {8864, 81}, {1810, 608}, {18965, 32}, {11169, 65}, {19520, 31}, {12048, 56}, {1810, 640}, {12583, 55}, {11767, 57}, {11190, 64}, {11430, 61}, {20189, 30}, {11787, 58}, {11801, 59}, {11118, 60}, {11422, 62}, {11196, 63}, {13056, 52}, {12597, 54}, {1809, 672}, {13063, 53}, {20785, 29}, {13224, 49}, {13345, 50}, {14502, 46}, {13390, 51}, {1810, 704}, {14117, 47}, {21364, 28}, {14006, 48}, {14560, 45}, {19396, 33}, {14740, 43}, {16765, 39}, {14780, 44}, {15246, 42}, {17027, 37}, {17687, 36}, {16606, 38}, {1809, 736}, {18256, 35}, {22825, 25}, {16031, 41}, {23311, 24}, {1810, 768}, {19896, 34}, {15900, 40}, {23812, 23}, {23827, 26}, {24081, 27}, {1810, 800}, {25166, 22}, {1763, 832}, {25995, 21}, {1763, 864}, {1625, 896}, {28765, 20}, {1626, 928}, {29809, 19}, {1627, 960}, {30622, 18}, {1624, 992}, {31641, 17}, {1495, 1024}, {34249, 16}, {36250, 15}, {37334, 14}, {39467, 13}, {43364, 12}, {44374, 11}, {49820, 10}, {53725, 9}, {60171, 8}, {69096, 7}, {81349, 6}, {94457, 5}, {118507, 4}, {150521, 3}, {206327, 2}, {385302, 1}},
{{1412, 225}, {1411, 233}, {1184, 272}, {1412, 241}, {1412, 249}, {1411, 217}, {1185, 288}, {1412, 256}, {1812, 209}, {1184, 304}, {1937, 145}, {1939, 137}, {1980, 177}, {1185, 320}, {1980, 193}, {1980, 201}, {1980, 185}, {2125, 153}, {1184, 336}, {2128, 161}, {2129, 169}, {1266, 352}, {2540, 113}, {2538, 105}, {2522, 129}, {2523, 121}, {2714, 81}, {1026, 368}, {1026, 384}, {2794, 89}, {3355, 61}, {3354, 63}, {3356, 64}, {3353, 62}, {1026, 400}, {3122, 97}, {3680, 57}, {1026, 416}, {3742, 55}, {3742, 56}, {3614, 73}, {1027, 432}, {1027, 448}, {3934, 51}, {3937, 50}, {4205, 65}, {4217, 49}, {4387, 60}, {4385, 59}, {1026, 464}, {4387, 58}, {6295, 31}, {6302, 32}, {1026, 480}, {6447, 30}, {4406, 43}, {4406, 44}, {1026, 496}, {5063, 37}, {5333, 36}, {4773, 54}, {4683, 48}, {4858, 42}, {4681, 47}, {6739, 33}, {6743, 29}, {4872, 53}, {4871, 52}, {7007, 34}, {5272, 38}, {5791, 35}, {1027, 512}, {5115, 46}, {7172, 28}, {5114, 45}, {7426, 24}, {5593, 39}, {7459, 25}, {1027, 544}, {5977, 40}, {7769, 23}, {5900, 41}, {8156, 26}, {1027, 576}, {8399, 22}, {8461, 27}, {551, 608}, {9407, 21}, {550, 640}, {9649, 18}, {10148, 17}, {10353, 19}, {550, 672}, {10726, 20}, {10698, 16}, {550, 704}, {11317, 15}, {12338, 14}, {550, 736}, {551, 768}, {13529, 12}, {13632, 13}, {14285, 11}, {550, 800}, {550, 832}, {15565, 10}, {550, 864}, {551, 896}, {17479, 9}, {551, 928}, {19778, 8}, {550, 960}, {550, 992}, {23013, 7}, {550, 1024}, {25515, 6}, {27392, 5}, {31304, 4}, {37731, 3}, {55647, 2}, {98982, 1}},
{{493, 89}, {525, 81}, {562, 73}, {350, 153}, {344, 161}, {605, 65}, {618, 64}, {409, 129}, {636, 62}, {406, 121}, {403, 137}, {632, 61}, {637, 63}, {406, 145}, {476, 97}, {367, 169}, {442, 105}, {434, 113}, {308, 177}, {683, 58}, {310, 185}, {687, 57}, {699, 56}, {694, 55}, {689, 59}, {708, 60}, {316, 193}, {736, 52}, {735, 54}, {736, 53}, {766, 50}, {767, 51}, {819, 48}, {344, 201}, {803, 49}, {813, 47}, {840, 45}, {841, 46}, {348, 209}, {880, 43}, {884, 44}, {342, 217}, {924, 42}, {932, 41}, {934, 40}, {342, 225}, {973, 39}, {354, 233}, {1004, 38}, {1019, 37}, {1045, 36}, {356, 241}, {347, 249}, {1116, 35}, {1141, 34}, {1145, 33}, {1177, 32}, {315, 256}, {1239, 31}, {1282, 30}, {1280, 29}, {321, 272}, {1362, 28}, {1389, 25}, {1409, 24}, {1414, 26}, {1420, 27}, {327, 288}, {1489, 23}, {326, 304}, {1625, 22}, {333, 320}, {1752, 21}, {1778, 20}, {1812, 19}, {1891, 18}, {331, 336}, {297, 352}, {2038, 17}, {2198, 16}, {307, 368}, {2339, 15}, {309, 384}, {2532, 14}, {312, 400}, {2704, 13}, {2753, 12}, {2872, 11}, {318, 416}, {3144, 10}, {316, 432}, {336, 448}, {340, 464}, {3531, 9}, {334, 480}, {320, 496}, {4110, 8}, {300, 512}, {4885, 7}, {5046, 6}, {304, 544}, {5383, 5}, {5561, 4}, {298, 576}, {5529, 3}, {5508, 2}, {311, 608}, {337, 640}, {344, 672}, {361, 704}, {362, 736}, {374, 768}, {10432, 1}, {381, 800}, {392, 832}, {387, 864}, {394, 896}, {399, 928}, {353, 960}, {324, 992}, {360, 1024}},
{{345, 121}, {384, 105}, {313, 137}, {343, 129}, {384, 113}, {281, 153}, {426, 97}, {316, 145}, {462, 89}, {277, 161}, {503, 81}, {243, 177}, {276, 169}, {560, 73}, {610, 65}, {620, 64}, {620, 62}, {621, 61}, {244, 185}, {620, 63}, {236, 193}, {701, 55}, {238, 201}, {692, 60}, {687, 59}, {685, 58}, {685, 57}, {701, 56}, {742, 52}, {734, 54}, {248, 209}, {738, 53}, {769, 51}, {764, 50}, {807, 49}, {813, 48}, {811, 47}, {202, 217}, {846, 45}, {844, 46}, {201, 225}, {870, 43}, {886, 44}, {922, 42}, {201, 233}, {929, 41}, {932, 40}, {959, 39}, {199, 241}, {1003, 38}, {199, 249}, {1031, 37}, {1031, 36}, {1107, 35}, {1134, 33}, {202, 256}, {1137, 34}, {1170, 32}, {1230, 31}, {183, 272}, {1277, 29}, {1276, 30}, {1354, 28}, {1369, 25}, {176, 288}, {1402, 26}, {1404, 24}, {1414, 27}, {1481, 23}, {170, 304}, {1626, 22}, {175, 320}, {1743, 21}, {1779, 20}, {173, 336}, {1813, 19}, {1898, 18}, {191, 352}, {2030, 17}, {2193, 16}, {145, 368}, {2410, 15}, {151, 384}, {2573, 14}, {150, 400}, {2756, 13}, {2805, 12}, {151, 416}, {2936, 11}, {138, 432}, {3211, 10}, {142, 448}, {146, 464}, {3608, 9}, {164, 480}, {147, 496}, {4153, 8}, {162, 512}, {4941, 7}, {5082, 5}, {5096, 6}, {5098, 4}, {182, 544}, {5104, 3}, {5083, 2}, {5282, 1}, {182, 576}, {138, 608}, {127, 640}, {152, 672}, {131, 704}, {132, 736}, {125, 768}, {167, 800}, {142, 832}, {134, 864}, {135, 896}, {134, 928}, {131, 960}, {130, 992}, {138, 1024}},
{{321, 121}, {363, 105}, {382, 97}, {403, 89}, {295, 137}, {323, 129}, {364, 113}, {442, 81}, {525, 15}, {259, 153}, {295, 145}, {522, 22}, {522, 30}, {524, 43}, {258, 161}, {526, 44}, {519, 60}, {521, 59}, {525, 58}, {257, 169}, {219, 177}, {568, 29}, {568, 36}, {565, 37}, {533, 73}, {567, 51}, {553, 65}, {568, 50}, {220, 185}, {221, 193}, {633, 38}, {613, 62}, {614, 64}, {615, 63}, {613, 61}, {637, 53}, {635, 52}, {645, 49}, {644, 57}, {678, 23}, {678, 31}, {222, 201}, {673, 45}, {679, 46}, {699, 55}, {226, 209}, {699, 56}, {189, 217}, {732, 21}, {731, 28}, {711, 54}, {727, 42}, {762, 39}, {188, 225}, {769, 35}, {809, 7}, {813, 14}, {838, 8}, {837, 16}, {188, 233}, {819, 47}, {819, 48}, {841, 32}, {189, 241}, {904, 41}, {922, 24}, {966, 5}, {189, 249}, {968, 11}, {971, 6}, {973, 9}, {971, 10}, {969, 12}, {968, 4}, {970, 13}, {968, 17}, {968, 3}, {969, 2}, {963, 27}, {965, 20}, {969, 19}, {968, 25}, {973, 18}, {957, 40}, {959, 34}, {966, 26}, {969, 33}, {1042, 1}, {191, 256}, {160, 272}, {158, 288}, {157, 304}, {152, 320}, {155, 336}, {153, 352}, {123, 368}, {127, 384}, {121, 400}, {117, 416}, {116, 432}, {112, 448}, {102, 464}, {96, 480}, {90, 496}, {92, 512}, {92, 544}, {93, 576}, {61, 608}, {62, 640}, {63, 672}, {62, 704}, {61, 736}, {60, 768}, {59, 800}, {62, 832}, {60, 864}, {62, 896}, {59, 928}, {61, 960}, {59, 992}, {63, 1024}},
{{228, 21}, {230, 28}, {226, 42}, {232, 56}, {296, 7}, {230, 55}, {256, 35}, {230, 61}, {229, 63}, {230, 62}, {231, 64}, {297, 14}, {231, 81}, {315, 49}, {229, 105}, {310, 57}, {333, 48}, {336, 47}, {273, 89}, {227, 113}, {228, 121}, {384, 41}, {438, 4}, {440, 5}, {435, 3}, {434, 8}, {399, 29}, {441, 6}, {435, 2}, {397, 36}, {441, 9}, {441, 10}, {440, 11}, {441, 13}, {438, 15}, {439, 12}, {234, 129}, {435, 16}, {397, 50}, {398, 51}, {431, 27}, {440, 17}, {440, 18}, {440, 19}, {429, 34}, {442, 20}, {426, 40}, {436, 22}, {438, 30}, {439, 25}, {440, 23}, {439, 33}, {440, 26}, {439, 32}, {436, 39}, {441, 24}, {436, 37}, {440, 31}, {399, 73}, {437, 43}, {440, 45}, {441, 46}, {430, 54}, {445, 38}, {441, 44}, {439, 53}, {440, 52}, {429, 65}, {222, 153}, {438, 59}, {437, 58}, {433, 60}, {387, 97}, {522, 1}, {218, 161}, {294, 137}, {295, 145}, {218, 169}, {210, 177}, {210, 185}, {209, 193}, {212, 201}, {211, 209}, {169, 217}, {173, 225}, {168, 233}, {169, 241}, {168, 249}, {166, 256}, {126, 272}, {127, 288}, {128, 304}, {128, 320}, {129, 336}, {126, 352}, {89, 368}, {89, 384}, {91, 400}, {89, 416}, {91, 432}, {89, 448}, {90, 464}, {90, 480}, {87, 496}, {88, 512}, {88, 544}, {90, 576}, {59, 608}, {59, 640}, {60, 672}, {59, 704}, {57, 736}, {60, 768}, {61, 800}, {59, 832}, {60, 864}, {61, 896}, {61, 928}, {61, 960}, {60, 992}, {59, 1024}},
{{36, 7}, {57, 2}, {55, 1}, {61, 3}, {62, 4}, {38, 14}, {62, 5}, {61, 6}, {63, 8}, {41, 15}, {59, 9}, {60, 10}, {60, 11}, {63, 13}, {36, 21}, {60, 12}, {36, 22}, {37, 27}, {38, 35}, {38, 30}, {37, 28}, {38, 29}, {36, 37}, {38, 36}, {60, 16}, {60, 17}, {39, 41}, {37, 51}, {51, 23}, {36, 42}, {39, 43}, {60, 19}, {38, 50}, {40, 45}, {36, 49}, {38, 44}, {35, 52}, {38, 46}, {48, 38}, {62, 18}, {60, 24}, {37, 53}, {38, 59}, {61, 25}, {59, 20}, {52, 39}, {60, 26}, {38, 60}, {38, 56}, {37, 57}, {37, 55}, {39, 54}, {61, 33}, {58, 32}, {39, 61}, {62, 34}, {62, 31}, {39, 62}, {38, 58}, {62, 40}, {38, 65}, {37, 64}, {41, 63}, {60, 48}, {60, 47}, {37, 73}, {39, 81}, {37, 89}, {38, 97}, {39, 105}, {40, 113}, {29, 121}, {30, 129}, {30, 137}, {30, 145}, {38, 153}, {39, 161}, {30, 169}, {31, 177}, {30, 185}, {30, 193}, {30, 201}, {31, 209}, {30, 217}, {32, 225}, {30, 233}, {30, 241}, {30, 249}, {29, 256}, {32, 272}, {30, 288}, {28, 304}, {30, 320}, {30, 336}, {31, 352}, {31, 368}, {30, 384}, {31, 400}, {31, 416}, {29, 432}, {30, 448}, {30, 464}, {34, 480}, {29, 496}, {32, 512}, {30, 544}, {28, 576}, {31, 608}, {32, 640}, {28, 672}, {33, 704}, {30, 736}, {32, 768}, {29, 800}, {32, 832}, {31, 864}, {31, 896}, {35, 928}, {32, 960}, {31, 992}, {30, 1024}}};

void distributePartitions(
          const int partitions,
          const int join_count,
          const int current_join,
          int &first,
          int &last) const;

void copyTaskAttributesFromThis(std::shared_ptr<PlanOperation> to);

std::vector<std::shared_ptr<Task> > build_probe_side(std::string prefix,
                                                          field_t &fields,
                                                          uint probe_par,
                                                          uint32_t bits1,
                                                          uint32_t bits2,
                                                          std::shared_ptr<Task> input);

std::vector<std::shared_ptr<Task> > build_hash_side(std::string prefix,
                                                          field_t &fields,
                                                          uint probe_par,
                                                          uint32_t bits1,
                                                          uint32_t bits2,
                                                          std::shared_ptr<Task> input);

};

}
}


#endif  // SRC_LIB_ACCESS_RADIXJOIN_H_
